name: Build Acumatica Customization

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment to deploy to (e.g. Dev, QA, Prod)'
        required: true
        default: 'Dev'
      branch:
        description: 'Git branch to build'
        required: true
        default: 'main'

jobs:
  build:
    runs-on: self-hosted

    env:
      SOLUTION: 'AcumaticaUSSFenceCustomizations[2024R1].sln'
      PROJECT: 'AcumaticaUSSFenceCustomizations[2024R1]\AcumaticaUSSFenceCustomizations[2024R1].csproj'
      ZIP_OUTPUT: 'AcumaticaUSSFenceCustomizations[2024R1].zip'

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.1

      - name: Install NuGet CLI
        uses: NuGet/setup-nuget@v1

      - name: Restore (if using NuGet)
        run: nuget restore $env:SOLUTION

      - name: Copy DLLs to bin\Release
        shell: pwsh
        run: | 
          $destination = "AcumaticaUSSFenceCustomizations[2024R1]\bin\Release\"
          New-Item -ItemType Directory -Force -Path $destination
          Copy-Item -Path "C:\Program Files\Acumatica ERP\USSFence\Bin\*" -Destination $destination -Force

      - name: Build Project
        run: msbuild $env:PROJECT /p:Configuration=Release

      - name: Copy DLL to Customization Bin
        shell: pwsh
        run: |
          Copy-Item "AcumaticaUSSFenceCustomizations[2024R1]\bin\Release\AcumaticaUSSFenceCustomizations[2024R1].dll" `
            -Destination "Customizations\AcumaticaUSSFenceCustomizations[2024R1]\Bin\" -Force

      - name: Create ZIP Package
        run: |
          Compress-Archive -Path "Customizations\AcumaticaUSSFenceCustomizations[2024R1]\*" `
            -DestinationPath $env:ZIP_OUTPUT -Force

      # - name: Publish to Acumatica Dev
      #   run: |
      #     pwsh ./scripts/publishCustomization.ps1 `
      #       -zipPath $env:ZIP_OUTPUT `
      #       -instanceUrl "${{ secrets.ACU_DEV_URL }}" `
      #       -username "${{ secrets.ACU_USERNAME }}" `
      #       -password "${{ secrets.ACU_PASSWORD }}"
